import { Router } from 'express';
import { z } from 'zod';
import { cebraspeEmbeddingsService } from '../services/cebraspe';

const router = Router();

// Interface para dados dos concursos do Cebraspe
interface ConcursoInfo {
  name: string;
  url: string;
  vagas?: string;
  salario?: string;
  score?: number;
}

// Dados dos concursos extra√≠dos do site (atualizados dinamicamente)
let concursosCebraspe: ConcursoInfo[] = [
  { name: "TJ CE NOT√ÅRIOS", url: "https://www.cebraspe.org.br/concursos/TJ_CE_25_NOTARIOS", vagas: "44 vagas" },
  { name: "TJ RO NOT√ÅRIOS", url: "https://www.cebraspe.org.br/concursos/TJ_RO_25_NOTARIOS", vagas: "26 vagas" },
  { name: "PGE ES PROCURADOR", url: "https://www.cebraspe.org.br/concursos/PGE_ES_25_PROCURADOR" },
  { name: "PREFEITURA BOA VISTA SA√öDE", url: "https://www.cebraspe.org.br/concursos/PREF_BOA_VISTA_25_SAUDE", vagas: "672 vagas", salario: "At√© R$ 7.506,17" },
  { name: "TJ RR NOT√ÅRIOS", url: "https://www.cebraspe.org.br/concursos/TJ_RR_25", vagas: "7 vagas" },
  { name: "ANS CURSO DE FORMA√á√ÉO", url: "https://www.cebraspe.org.br/concursos/ANS_25_CF" },
  { name: "BANRISUL", url: "https://www.cebraspe.org.br/concursos/BANRISUL_25", vagas: "100 vagas", salario: "At√© R$ 5.847,62" },
  { name: "CAESB", url: "https://www.cebraspe.org.br/concursos/CAESB_24", vagas: "82 vagas", salario: "At√© R$ 11.961,34" },
  { name: "CAU MG", url: "https://www.cebraspe.org.br/concursos/CAU_MG_25", vagas: "9 vagas", salario: "At√© R$ 12.903,39" },
  { name: "EMBRAPA", url: "https://www.cebraspe.org.br/concursos/EMBRAPA_24" },
  { name: "FUB", url: "https://www.cebraspe.org.br/concursos/FUB_25", vagas: "273 vagas", salario: "At√© R$ 4.967,04" },
  { name: "INSS", url: "https://www.cebraspe.org.br/concursos/INSS_22", vagas: "1000 vagas", salario: "At√© R$ 5.905,79" },
  { name: "IRBR DIPLOMACIA", url: "https://www.cebraspe.org.br/concursos/IRBR_25_DIPLOMACIA", vagas: "50 vagas", salario: "At√© R$ 22.558,56" },
  { name: "POL√çCIA CIVIL CEAR√Å DELEGADO", url: "https://www.cebraspe.org.br/concursos/PC_CE_25_DELEGADO", vagas: "100 vagas", salario: "At√© R$ 22.165,53" },
  { name: "POL√çCIA CIVIL PERNAMBUCO", url: "https://www.cebraspe.org.br/concursos/PC_PE_23" },
  { name: "POL√çCIA FEDERAL", url: "https://www.cebraspe.org.br/concursos/PF_25", vagas: "1000 vagas", salario: "At√© R$ 26.800,00" },
  { name: "POL√çCIA FEDERAL ADM", url: "https://www.cebraspe.org.br/concursos/PF_25_ADM", vagas: "192 vagas", salario: "At√© R$ 11.070,93" },
  { name: "PGE PI", url: "https://www.cebraspe.org.br/concursos/PGE_PI_25", vagas: "10 vagas", salario: "At√© R$ 32.319,67" },
  { name: "PGE PR PROCURADOR", url: "https://www.cebraspe.org.br/concursos/PGE_PR_24_PROCURADOR" },
  { name: "PGM ARACAJU PROCURADOR", url: "https://www.cebraspe.org.br/concursos/PGM_ARACAJU_24_PROCURADOR" },
  { name: "PGM CUIAB√Å PROCURADOR", url: "https://www.cebraspe.org.br/concursos/PGM_CUIABA_24_PROCURADOR", vagas: "6 vagas", salario: "At√© R$ 17.516,64" },
  { name: "POL√çCIA MILITAR SANTA CATARINA SOLDADO", url: "https://www.cebraspe.org.br/concursos/PM_SC_23_SOLDADO" },
  { name: "PMDF CFO", url: "https://www.cebraspe.org.br/concursos/PM_DF_25_CFO", vagas: "49 vagas", salario: "At√© R$ 17.034,85" },
  { name: "PREFEITURA ANDRADINA PROCURADOR", url: "https://www.cebraspe.org.br/concursos/PREF_ANDRADINA_25_PROCURADOR", vagas: "1 vagas", salario: "At√© R$ 13.656,70" },
  { name: "PREFEITURA CACHOEIRO GUARDA", url: "https://www.cebraspe.org.br/concursos/PREF_CACHOEIRO_24_GUARDA" },
  { name: "POL√çCIA RODOVI√ÅRIA FEDERAL", url: "https://www.cebraspe.org.br/concursos/PRF_21", vagas: "1500 vagas" },
  { name: "SEFAZ SE AUDITOR", url: "https://www.cebraspe.org.br/concursos/SEFAZ_SE_25_AUDITOR", vagas: "10 vagas", salario: "At√© R$ 22.541,47" },
  { name: "SEFAZ RJ ANALISTA", url: "https://www.cebraspe.org.br/concursos/SEFAZ_RJ_25_ANALISTA", vagas: "28 vagas", salario: "At√© R$ 6.788,13" },
  { name: "SEFAZ RJ AUDITOR", url: "https://www.cebraspe.org.br/concursos/SEFAZ_RJ_25_AUDITOR", salario: "At√© R$ 5.387,39" },
  { name: "SEPLAD DF AUDITOR", url: "https://www.cebraspe.org.br/concursos/SEPLAD_DF_22_AUDITOR" },
  { name: "STM", url: "https://www.cebraspe.org.br/concursos/STM_25", vagas: "80 vagas", salario: "At√© R$ 14.852,66" },
  { name: "SUSEP", url: "https://www.cebraspe.org.br/concursos/SUSEP_25", vagas: "75 vagas", salario: "At√© R$ 18.033,52" },
  { name: "TC DF PROCURADOR", url: "https://www.cebraspe.org.br/concursos/TC_DF_24_PROCURADOR" },
  { name: "TCE MS SERVIDOR", url: "https://www.cebraspe.org.br/concursos/TCE_MS_25", vagas: "5 vagas", salario: "At√© R$ 14.232,67" },
  { name: "TCE MS CONSELHEIRO", url: "https://www.cebraspe.org.br/concursos/TCE_MS_25_CONSELHEIRO", vagas: "1 vagas", salario: "At√© R$ 39.753,22" },
  { name: "TCE RS", url: "https://www.cebraspe.org.br/concursos/TCE_RS_25", vagas: "45 vagas", salario: "At√© R$ 20.572,72" },
  { name: "TCU TEFC", url: "https://www.cebraspe.org.br/concursos/TCU_25_TEFC", vagas: "40 vagas", salario: "At√© R$ 15.128,26" },
  { name: "TJ MT NOT√ÅRIOS", url: "https://www.cebraspe.org.br/concursos/TJ_MT_24_NOTARIOS" },
  { name: "TJ PA SERVIDOR", url: "https://www.cebraspe.org.br/concursos/TJ_PA_25_SERVIDOR", vagas: "50 vagas", salario: "At√© R$ 15.021,89" },
  { name: "TJ PE NOT√ÅRIOS", url: "https://www.cebraspe.org.br/concursos/TJ_PE_24_NOTARIOS" },
  { name: "TJ SC NOT√ÅRIOS", url: "https://www.cebraspe.org.br/concursos/TJ_SC_22_NOTARIOS", vagas: "22 vagas" },
  { name: "TRT10", url: "https://www.cebraspe.org.br/concursos/TRT10_24", vagas: "8 vagas", salario: "At√© R$ 16.035,69" }
];

// Fun√ß√£o para extrair ano do nome do concurso
function extractYearFromName(name: string): number {
  // Primeiro, procurar por ano de 4 d√≠gitos (mais preciso)
  const fullYearMatch = name.match(/(19|20)\d{2}(?!.*\d{4})/); // √öltimo ano de 4 d√≠gitos
  if (fullYearMatch) {
    return parseInt(fullYearMatch[0]);
  }
  
  // Depois, procurar por 2 d√≠gitos em qualquer lugar (ex: TJ_CE_25, PF_25_ADM)
  const twoDigitMatches = name.match(/\d{2}/g); // Todos os 2 d√≠gitos
  if (twoDigitMatches && twoDigitMatches.length > 0) {
    // Pegar o √∫ltimo encontrado (geralmente representa o ano)
    const lastTwoDigits = twoDigitMatches[twoDigitMatches.length - 1];
    const year = parseInt(lastTwoDigits);
    // Assumir que anos 20-50 s√£o 2020-2050, e 51-99 s√£o 1951-1999
    return year <= 50 ? 2000 + year : 1900 + year;
  }
  
  return 0; // Sem data identificada
}

// Fun√ß√£o para ordenar concursos por data ou nome
function sortConcursos(concursos: any[]): any[] {
  return concursos.sort((a, b) => {
    const yearA = extractYearFromName(a.name);
    const yearB = extractYearFromName(b.name);
    
    // Se ambos t√™m data, ordenar por data (mais recente primeiro)
    if (yearA > 0 && yearB > 0) {
      return yearB - yearA;
    }
    
    // Se apenas um tem data, priorizar o que tem data
    if (yearA > 0 && yearB === 0) return -1;
    if (yearA === 0 && yearB > 0) return 1;
    
    // Se nenhum tem data clara, ordenar por nome
    return a.name.localeCompare(b.name);
  });
}

// Interface expandida para incluir m√∫ltiplas op√ß√µes
interface SearchResult {
  success: boolean;
  concurso?: ConcursoInfo;
  multipleOptions?: ConcursoInfo[];
  message?: string;
}

// Fun√ß√£o para buscar concursos usando RAG
async function findMatchesRAG(userInput: string): Promise<SearchResult> {
  try {
    console.log(`üîç Buscando concurso via RAG: "${userInput}"`);
    
    // Usar o servi√ßo RAG para buscar concursos
    const results = await cebraspeEmbeddingsService.buscarConcursoPorRAG(userInput);
    
    if (results.length === 0) {
      console.log('‚ùå Nenhum concurso encontrado via RAG');
      return {
        success: false,
        message: 'N√£o foi poss√≠vel encontrar um concurso correspondente no Cebraspe'
      };
    }
    
    // Filtrar resultados com score m√≠nimo aceit√°vel (0.3) e parsing robusto
    const validResults = results.filter(result => {
      const scoreMatch = result.description?.match(/(?:score|similaridade|relev√¢ncia)\s*[:=]\s*([\d.,]+)/i) || 
                          result.description?.match(/([\d.]+)/);
      const score = scoreMatch ? parseFloat(scoreMatch[1].replace(',', '.')) : 0;
      return !isNaN(score) && score >= 0.3 && score <= 1.0;
    }).map(result => {
      const scoreMatch = result.description?.match(/(?:score|similaridade|relev√¢ncia)\s*[:=]\s*([\d.,]+)/i) || 
                          result.description?.match(/([\d.]+)/);
      const score = scoreMatch ? parseFloat(scoreMatch[1].replace(',', '.')) : 0;
      return { ...result, numericScore: score };
    }).sort((a, b) => b.numericScore - a.numericScore); // Ordenar por score descendente
    
    console.log(`üìä Encontrados ${validResults.length} resultados v√°lidos`);
    
    // Se n√£o h√° resultados v√°lidos ap√≥s filtragem
    if (validResults.length === 0) {
      return {
        success: false,
        message: 'N√£o encontramos concursos com relev√¢ncia suficiente. Tente termos mais espec√≠ficos como "PF", "INSS" ou "Tribunal".'
      };
    }
    
    // Se h√° apenas um resultado v√°lido, retornar diretamente
    if (validResults.length === 1) {
      const bestMatch = validResults[0];
      console.log(`‚úÖ √önico match: ${bestMatch.name} (Score: ${bestMatch.numericScore.toFixed(3)})`);
      
      return {
        success: true,
        concurso: {
          name: bestMatch.name,
          url: bestMatch.url,
          vagas: bestMatch.vagas,
          salario: bestMatch.salario,
          score: bestMatch.numericScore
        }
      };
    }
    
    // Se h√° m√∫ltiplos resultados v√°lidos, verificar se precisamos de sele√ß√£o
    if (validResults.length > 1) {
      const topScore = validResults[0].numericScore;
      const secondScore = validResults[1].numericScore;
      
      // Mostrar m√∫ltiplas op√ß√µes se:
      // 1. Diferen√ßa entre primeiro e segundo √© pequena (< 0.15), OU
      // 2. Score mais alto √© baixo (< 0.7), indicando incerteza
      const scoreDifference = topScore - secondScore;
      const showMultiple = scoreDifference < 0.15 || topScore < 0.7;
      
      console.log(`üìä Diferen√ßa de score: ${scoreDifference.toFixed(3)}, Top score: ${topScore.toFixed(3)}`);
      
      if (showMultiple) {
        console.log(`üîÄ M√∫ltiplas op√ß√µes encontradas (${validResults.length})`);
        
        // Ordenar por data/nome
        const sortedResults = sortConcursos(validResults);
        
        const multipleOptions = sortedResults.slice(0, 8).map(result => ({ // Limitar a 8 op√ß√µes
          name: result.name,
          url: result.url,
          vagas: result.vagas,
          salario: result.salario,
          score: result.numericScore
        }));
        
        return {
          success: true,
          multipleOptions,
          message: `Encontramos ${validResults.length} concursos que correspondem √† sua busca. Selecione o desejado:`
        };
      }
    }
    
    // Retornar o melhor resultado
    const bestMatch = validResults[0];
    console.log(`‚úÖ Melhor match: ${bestMatch.name} (Score: ${bestMatch.numericScore.toFixed(3)})`);
    
    return {
      success: true,
      concurso: {
        name: bestMatch.name,
        url: bestMatch.url,
        vagas: bestMatch.vagas,
        salario: bestMatch.salario,
        score: bestMatch.numericScore
      }
    };
  } catch (error) {
    console.error('‚ùå Erro na busca RAG:', error);
    return {
      success: false,
      message: 'Erro interno do servidor'
    };
  }
}

// Schema para valida√ß√£o
const searchConcursoSchema = z.object({
  query: z.string().min(1, 'Nome do concurso √© obrigat√≥rio')
});

// Endpoint para processar concursos no Pinecone (admin)
router.post('/process-embeddings', async (req, res) => {
  try {
    console.log('üöÄ Iniciando processamento de embeddings dos concursos...');
    await cebraspeEmbeddingsService.processarConcursosParaPinecone();
    
    res.json({
      success: true,
      message: 'Todos os concursos foram processados e indexados no Pinecone'
    });
  } catch (error) {
    console.error('Erro ao processar embeddings:', error);
    res.status(500).json({
      success: false,
      error: 'Erro ao processar embeddings dos concursos'
    });
  }
});

// Endpoint para buscar concurso usando RAG
router.post('/search', async (req, res) => {
  try {
    const { query } = searchConcursoSchema.parse(req.body);
    
    console.log(`üîç Buscando concurso para: "${query}"`);
    
    const searchResult = await findMatchesRAG(query);
    
    if (searchResult.success) {
      if (searchResult.multipleOptions) {
        console.log(`üîÄ M√∫ltiplas op√ß√µes encontradas: ${searchResult.multipleOptions.length}`);
        res.json({
          success: true,
          multipleOptions: searchResult.multipleOptions,
          message: searchResult.message
        });
      } else if (searchResult.concurso) {
        console.log(`‚úÖ Concurso encontrado: ${searchResult.concurso.name}`);
        res.json({
          success: true,
          concurso: searchResult.concurso
        });
      }
    } else {
      console.log('‚ùå Nenhum concurso encontrado');
      res.json({
        success: false,
        message: searchResult.message || 'N√£o foi poss√≠vel encontrar um concurso correspondente no Cebraspe'
      });
    }
  } catch (error) {
    console.error('‚ùå Erro ao buscar concurso:', error);
    res.status(500).json({
      success: false,
      error: 'Erro interno do servidor'
    });
  }
});

export { router as cebraspeRouter };